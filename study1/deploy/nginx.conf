worker_processes 4;

# Enables the use of JIT for regular expressions to speed-up their processing.
pcre_jit on;

#pid /run/nginx/nginx.pid;
pid /var/run/nginx.pid;

events {
  worker_connections 4096;
  #worker_connections 65536;
  use epoll;
  multi_accept on;
}

worker_rlimit_nofile 8192;

   http {

  # Includes mapping of file name extensions to MIME types of responses
  # and defines the default type.
  include /opt/nginx-1.12.2/conf/mime.types;
  default_type application/octet-stream;

  client_body_buffer_size 128k;

  # Specifies the maximum accepted body size of a client request, as
  # indicated by the request header Content-Length. If the stated content
  # length is greater than this size, then the client receives the HTTP
  # error code 413. Set to 0 to disable.
  client_max_body_size 300M;

  client_header_buffer_size 1k;
  large_client_header_buffers 4 4k;
  output_buffers 1 32k;
  postpone_output 1460;
  client_header_timeout 3m;
  client_body_timeout 3m;
  send_timeout 3m;
  open_file_cache max=1000 inactive=20s;
  open_file_cache_valid 30s;
  open_file_cache_min_uses 5;
  open_file_cache_errors off;

  # Sendfile copies data between one FD and other from within the kernel,
  # which is more efficient than read() + write().
  sendfile on;

  # Causes nginx to attempt to send its HTTP response head in one packet,
  # instead of using partial frames.
  tcp_nopush on;

  # Don't buffer data-sends (disable Nagle algorithm).
  # Good for sending frequent small bursts of data in real time.
  tcp_nodelay on;

  # Timeout for keep-alive connections. Server will close connections after
  # this time
  #keepalive_timeout 65;

  types_hash_max_size 2048;

  # Don't tell nginx version to clients.
  server_tokens off;
  proxy_pass_header Server;

   #limit_req_zone $binary_remote_addr zone=userhub:10m rate=10r/s;
   #limit_req_zone $binary_remote_addr zone=devichub:10m rate=10r/s;

  add_header X-Frame-Options DENY;
  keepalive_timeout 5s 5s;
  add_header Strict-Transport-Security 'max-age=31536000; includeSubDomains' always;
  #add_header Content-Security-Policy "default-src 'self' style-src 'self' 'unsafe-inline';" always;
  add_header Content-Security-Policy "style-src 'self' 'unsafe-inline'" always; 

  


  log_format main '$remote_addr - $remote_user [$time_iso8601] "$request" '
                  '$status $body_bytes_sent "$http_referer" '
                  '"$http_user_agent" "$http_x_forwarded_for"' '"$ssl_client_s_dn"' '" $ssl_client_serial"'
    			  '$request_length $request_time $upstream_addr $upstream_response_length $upstream_response_time $upstream_status';
  
  
#  access_log /var/log/nginx/access.log;
 # error_log /var/log/nginx/error.log;


  #access_log /logs/access-ssl.log main;
 # error_log /logs/error-ssl.log;

  # Enable gzipping of responses.
  gzip on;

  gzip_disable "msie6";

   # Includes virtual hosts configs.


    #upstream test {
     #   server ncui.default.svc.cluster.local:4001;
      # server uc1c-nextconnect-slb01.sial.com:31133;
    #}
  
#Adding below changes to test remote-connectivity issue in INT
#revering now
#  upstream devicehub {
#        server ncs.default.svc.cluster.local:8000;
#        keepalive 64;
#     }  

   # HTTPS server
    #
    server {
        listen       443 default_server ssl;
        server_name  int-nextconnect.sial.com;
        root        /var/www/appliance-portal;
        ssl on;
        ssl_certificate /opt/nginx-1.12.2/ssl-certs/tls.crt;
        ssl_certificate_key /opt/nginx-1.12.2/ssl-certs/tls.key;
        #ssl_trusted_certificate ssl/dev-nextconnect.sial.com-ca.crt;
        ssl_client_certificate /opt/nginx-1.12.2/client-certs/lab-water-client.cert;

        #ssl_certificate ssl/nc-int.crt;
        #ssl_certificate_key ssl/nc-int.key;
        #ssl_trusted_certificate ssl/ca-chain.crt;
        #ssl_crl ssl/combined.crl;
        #ssl_client_certificate ssl/lab-water-client.cert;

        #ssl_verify_client optional_no_ca;
        ssl_verify_client optional;
        #ssl_verify_client on;
        ssl_verify_depth 2;
        ssl_session_timeout 5m;
        #ssl_protocols SSLv3 TLSv1 TLSv1.1 TLSv1.2;
        #ssl_ciphers "HIGH:!aNULL:!MD5 or HIGH:!aNULL:!MD5:!3DES";
        ssl_ciphers 'EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH';
        ssl_protocols TLSv1.2;
        ssl_prefer_server_ciphers on;
        underscores_in_headers on;
         # Compression

    gzip on;
    gzip_comp_level 5;
    gzip_min_length 256;
    gzip_proxied any;
    gzip_vary on;
    gzip_types
      application/atom+xml
      application/x-javascript
      application/json
      application/rss+xml
      application/vnd.ms-fontobject
      application/x-font-ttf
      application/x-web-app-manifest+json
      application/xhtml+xml
      application/xml
      font/opentype
      image/svg+xml
      image/x-icon
      text/css
      text/plain
      text/x-component;
    
    # for testing the new feature
  if ($http_x_requesttype = "ajax") {
        return 301 https://google.com$request_uri;
    }

if ($http_x_requesttype) {
        return 403;
     }  

# commenting out redirection for new theme    
#       if ($http_referer ~ ://[^/]*(/applications/*)/) {
#
#         rewrite ^(/)$ /nextconnect/remote/api/device/remote/data break;
#      }
#Adding below line for checking remote connectivity issue in INT   
#reverting now    
#    	rewrite ^(/)(.*)$ /nextconnect/remote/api/device/remote/data$1$2;
    
    	rewrite ^(/web)(.*)$ /nextconnect/remote/api/device/remote/data$1$2;
      	rewrite ^(/public)(.*)$ /nextconnect/remote/api/device/remote/data$1$2;
		rewrite ^(/static)(.*)$ /nextconnect/remote/api/device/remote/data$1$2;
#Commenting below line for remote connectivity issue in INT
#reverting now    
    	rewrite ^(/api)(.*)$ /nextconnect/remote/api/device/remote/data$1$2;
        rewrite ^(/applications)(.*)$ /nextconnect/remote/api/device/remote/data$1$2;
        rewrite ^(/wizard)(.*)$ /nextconnect/remote/api/device/remote/data$1$2;
        rewrite ^(/processthread)(.*)$ /nextconnect/remote/api/device/remote/data$1$2;
        rewrite ^(/services)(.*)$ /nextconnect/remote/api/device/remote/data$1$2;
        rewrite ^(/alarms)(.*)$ /nextconnect/remote/api/device/remote/data$1$2;
        rewrite ^(/consumables)(.*)$ /nextconnect/remote/api/device/remote/data$1$2;
    	rewrite ^(/factory)(.*)$ /nextconnect/remote/api/device/remote/data$1$2;
        #rewrite ^(/home)(.*)$ /nextconnect/remote/api/device/remote/data$1$2;


      

         location = /resetpassword {
      # IOS/AndroidOS browser: redirect to native app
	 
      if ($http_user_agent ~* iPhone|iPod|iPad|Android) {
        return 302 nextconnectstg://resetpassword?token=$arg_token;
      }
      try_files $uri /index.html ;
    }

    location / {
      try_files $uri /index.html ;
      #  if ($http_x_requesttype = "ajax") {
       # return 301 https://google.com$request_uri;
    #}

#if ($http_x_requesttype) {
 #       return 403;
  #   }  
    }

      location ^~ /nextconnect/version {
         types        { }
         default_type application/json;
         proxy_set_header Content-Type application/json;
         #alias /opt/nginx-1.12.2/version/versions.json;
         proxy_set_header Accept application/json;
         proxy_pass_request_headers      on;
         alias /opt/nginx-1.12.2/version/versions.json;
    }

      
        #deviceimages
        location ^~ /nextconnect/device-images/ {
        alias    /device-images/;
      }


        # Intl Messages
    location ^~ /nextconnect/translations/ {
      alias /opt/nginx-1.12.2/translations/;
    }

        location ^~ /nextconnect/userhub/ {
		#limit_req zone=userhub
      proxy_set_header Content-Type application/json;
      proxy_set_header Accept application/json;
          proxy_pass_request_headers      on;
      proxy_set_header  X-Real-IP $remote_addr;
      proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header  Host $http_host;

          if ($request_method !~ ^(GET|POST|PUT|DELETE|PATCH)$) {
                 return 444;
          }

      proxy_pass http://ncuserhubsvc.default.svc.cluster.local:9000;
    }

         location ^~ /nextconnect/devicehub/ {
	#limit_req zone=devicehub
      #proxy_set_header Content-Type application/json;
      #proxy_set_header Accept application/json;
      proxy_set_header Accept */*;
      proxy_pass_request_headers      on;
      proxy_set_header  X-Real-IP $remote_addr;
      proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header  Host $http_host;
      proxy_read_timeout 1800s;
      proxy_connect_timeout 1800s;
      proxy_send_timeout 1800s;
      send_timeout 1800s;
	  proxy_request_buffering off;

      proxy_pass http://ncs.default.svc.cluster.local:8000;
    }

        location ^~ /nextconnect/how-to/ {

                proxy_set_header Accept */*;
                proxy_pass_request_headers      on;
                proxy_set_header  X-Real-IP $remote_addr;
                proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header  Host $http_host;
      			proxy_read_timeout 1800s;
      			proxy_connect_timeout 1800s;
      			proxy_send_timeout 1800s;
      			send_timeout 1800s;
                proxy_pass http://nchowto-service.default.svc.cluster.local:8092;
    }

	        location ^~ /nextconnect/ncblint/ {

                proxy_set_header Accept */*;
                proxy_pass_request_headers      on;
                proxy_set_header  X-Real-IP $remote_addr;
                proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header  Host $http_host;
                proxy_pass http://bl-nc-int.default.svc.cluster.local:8080;
    }
	
      location ^~ /nextconnect/filescan/ {
 
      proxy_set_header Accept */*;
          proxy_pass_request_headers      on;
      proxy_set_header  X-Real-IP $remote_addr;
      proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header  Host $http_host;
      proxy_pass  http://ncfilescanutilsvc.default.svc.cluster.local:8080; 
     
     }
      
         #changes in nginx-config                                            
     location ^~ /sso/ {
     proxy_pass_request_headers      on;                                                                                                                                                                               
     proxy_set_header  X-Real-IP $remote_addr;                                                                                                                                                                       
     proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;                                                                                                                                                  
     proxy_set_header  Host $http_host;                                                                                                                                                                            
         if ($request_method !~ ^(GET|POST|PUT|DELETE|PATCH)$) {                                                                                                                                                       
                return 444;                                                                                                                                                          
        }                                                                                                  
     proxy_pass http://ncuserhubsvc.default.svc.cluster.local:9000/nextconnect/userhub/api/login/sso; 
    } 
  
                                                                                                      
     location ^~ /samlLogin {
     proxy_pass_request_headers      on;                                                              
     proxy_set_header  X-Real-IP $remote_addr;                                                        
     proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;                                    
     proxy_set_header  Host $http_host;                                                                                                                                            
      if ($request_method !~ ^(GET|POST|PUT|DELETE|PATCH)$) {     
                 return 444;                                      
      }                                                                  
     proxy_pass http://ncuserhubsvc.default.svc.cluster.local:9000/nextconnect/userhub/api/login/sso/reply;
                                                                          
    }                                                                                                       
       
      


         location ^~ /nextconnect/analytics/ {

      proxy_set_header Accept */*;
          proxy_pass_request_headers      on;
      proxy_set_header  X-Real-IP $remote_addr;
      proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header  Host $http_host;

      proxy_pass http://ncanalytics.default.svc.cluster.local:8001;
    }
         location ^~ /ycrash/ {

      proxy_set_header Accept */*;
          proxy_pass_request_headers      on;
      proxy_set_header  X-Real-IP $remote_addr;
      proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header  Host $http_host;

      proxy_pass http://yc-web.default.svc.cluster.local:8080/;
    }
        

        location ^~ /nextconnect/filemanagement/ {
      proxy_set_header Accept */*;
          proxy_pass_request_headers      on;
      proxy_set_header  X-Real-IP $remote_addr;
      proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header  Host $http_host;
      proxy_pass http://ncfile.default.svc.cluster.local:8095;
    }

        location ^~ /hazelcast-mancenter/ {

      		proxy_set_header Accept */*;
          	proxy_pass_request_headers      on;
      		proxy_set_header  X-Real-IP $remote_addr;
      		proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;
      		proxy_set_header  Host $http_host;
      		proxy_pass http://management.default.svc.cluster.local:8085;
    }
	        location ^~ /nextconnect/kpi/ {

      		proxy_set_header Accept */*;
          	proxy_pass_request_headers      on;
      		proxy_set_header  X-Real-IP $remote_addr;
      		proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;
      		proxy_set_header  Host $http_host;
      		proxy_pass http://nckpihub-service.default.svc.cluster.local:8090;
    }

       location ^~ /nextconnect/remote/ {
			# kill cache
        	add_header Last-Modified $date_gmt;
       	    add_header Cache-Control 'no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0';
            if_modified_since off;
            expires off;
            etag off;
            proxy_set_header Accept */*;
			proxy_connect_timeout 600s;
            proxy_send_timeout 600s;
            proxy_read_timeout 600s;
            proxy_pass_request_headers      on;
            proxy_set_header  X-Real-IP $remote_addr;
            proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header  Host $http_host;
            proxy_pass http://nc-remote:9001;

        }

        location ^~ /api-docs/ {
            #proxy_pass        http://test;
            proxy_pass        http://tomcat.default.svc.cluster.local:8080;
            #proxy_pass        http://ncdevicelogging.default.svc.cluster.local:9095;
            proxy_pass_request_headers      on;
            proxy_set_header  X-Real-IP $remote_addr;
            proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header  Host $http_host;
            proxy_set_header X-SSL-Client-S-DN $ssl_client_s_dn;
            proxy_set_header X-SSL-Client-S-SERIAL $ssl_client_serial;

          if ($request_method !~ ^(GET|POST|PUT|DELETE|PATCH)$) {
                 return 444;
          }
        }

      # Health Check
       location = /ping {
      return 200;
     }
     # From https://easyengine.io/tutorials/nginx/status-page/
       location = /nginx_status {
       stub_status on;
       access_log off;
       allow 127.0.0.1;
       deny all;
      }
        access_log  /logs/access.log  main;
		error_log  /logs/error.log info;
  		#access_log /logs/access-ssl.log main;
        #error_log /logs/error-ssl.log;
       # access_log /tmp/access-ssl.log;
       # error_log /tmp/error-ssl.log;
    }

}
