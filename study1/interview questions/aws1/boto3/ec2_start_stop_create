#1)start-stop
import boto3
import os
ec2 = boto3.client('ec2')
def lambda_handler(event, context):
    instance_id = event['instance_id']
    action = event.get("action", "start")
    if action == "start":
        ec2.start_instances(InstanceIds=[instance_id])
        return {"status": "success", "message": f"EC2 {instance_id} starting"}
    elif action == "stop":
        ec2.stop_instances(InstanceIds=[instance_id])
        return {"status": "success", "message": f"EC2 {instance_id} stopping"}
    else:
        return {"status": "error", "message": "Invalid action"}
#++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#2) create $ wait until ec2 is in running status
import boto3
# Create a Boto3 session
session = boto3.Session(
    aws_access_key_id='YOUR_ACCESS_KEY_ID',
    aws_secret_access_key='YOUR_SECRET_ACCESS_KEY',
    region_name='us-west-2'
)
# Use the session to create a client for the EC2 service
ec2_client = session.client('ec2')
# Use the client to create an EC2 instance
response = ec2_client.run_instances(
    ImageId='ami-123456',
    MinCount=1,
    MaxCount=1,
    InstanceType='t2.micro'
)
# Get the instance ID of the new instance
instance_id = response['Instances'][0]['InstanceId']
# Create a waiter to wait for the instance to reach the 'running' state
waiter = ec2_client.get_waiter('instance_running')
# Wait for the instance to start
waiter.wait(InstanceIds=[instance_id])
# Print a message indicating that the instance is running
print(f'Instance {instance_id} is now running')

#4) ec2_instance_conversion
#!/usr/bin/env python3
# Python script to convert EC2 instance from one type to another and read input from csv file with a format instance_id,instance_type

import argparse
import boto3
import sys
import csv

def convert_instance(instance_id, new_instance_type, csv_file=None):
    # Create an EC2 client
    ec2 = boto3.client('ec2')
    
    # Check if the instance is in a stopped state
    response = ec2.describe_instances(InstanceIds=[instance_id])
    instance_state = response['Reservations'][0]['Instances'][0]['State']['Name']
    if instance_state == 'stopped':
        snapshot_response = input("The instance is in a stopped state. Please don't forget to take the ebs snapshot of the instance volume before the conversion y/n")
    try:
        # Modify the instance
        ec2.modify_instance_attribute(InstanceId=instance_id, Attribute='instanceType', Value=new_instance_type)
        print("Successfully converted instance", instance_id, "to", new_instance_type)
    except Exception as e:
        print("Error converting instance:", e)

if __name__ == '__main__':
    # Set up the argument parser
    parser = argparse.ArgumentParser(description='Convert an EC2 instance from one type to another')
    parser.add_argument('-instance_id', help='The ID of the EC2 instance to convert')
    parser.add_argument('-new_instance_type', help='The new instance type for the EC2 instance')
    parser.add_argument("-f","--file", help='A CSV file containing a list of instances and new instance types')
    args = parser.parse_args()
    if not any(vars(args).values()):
        parser.print_help()
        sys.exit()
    if args.file:
        with open(args.file, 'r') as f:
            reader = csv.reader(f)
            for row in reader:
                instance_id = row[0]
                new_instance_type = row[1]
                convert_instance(instance_id, new_instance_type)  
    else:
        convert_instance(args.instance_id, args.new_instance_type)            
